{% extends 'base_html/base.html' %} 
{% block title %} 
  Lista de Cautelas 
{% endblock %} 
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4 text-center">Registros de Cautelas</h2>

  <!-- Campo de pesquisa -->
  <div class="row mb-3">
    <div class="col-md-4">
      <label for="search_input" class="form-label">Pesquisar</label>
      <input
        type="text"
        id="search_input"
        class="form-control"
        placeholder="Digite para pesquisar..."
      />
    </div>
  </div>

  <!-- Tabela de registros -->
  <table class="table table-bordered table-striped">
    <thead class="table-light">
      <tr>
        <th>Data e Hora</th>
        <th>Policial</th>
        <th>Tipo de Serviço</th>
        <th>Categoria Armamento</th>
        <th>Subcategoria Armamento</th>
        <th>Categoria Munição</th>
        <th>Subcategoria Munição</th>
        <th>Quantidade Munição</th>
        <th>Armeiro</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="registros_tbody">
      {% for registro in registros %}
      <tr data-registro-id="{{ registro.id }}">
        <td>{{ registro.data_hora }}</td>
        <td>{{ registro.policial.nome }}</td>
        <td>{{ registro.tipo_servico }}</td>
        <td>{{ registro.categoria_armamento }}</td>
        <td>{{ registro.subcategoria_armamento }}</td>
        <td>{{ registro.categoria_municao }}</td>
        <td>{{ registro.subcategoria_municao }}</td>
        <td>{{ registro.quantidade_municao }}</td>
        <td>{{ registro.armeiro.username }}</td>
        <td>
          <!-- Botão para descautela sem armamento (S/A) -->
          <button
            class="btn btn-danger btn-sm"
            onclick="openDescautelarSAModal({{ registro.id }}, '{{ registro.policial.nome }}')"
          >
            Descautela S/A
          </button>

          <!-- Verifica se a categoria de armamento está presente no registro -->
          {% if registro.categoria_armamento %}
          <!-- Se houver categoria de armamento, renderiza o botão de descautela com armamento (C/A) -->
          <button
            class="btn btn-primary btn-sm"
            onclick="openDescautelarArmamentoModal({{ registro.id }}, '{{ registro.categoria_armamento }}', '{{ registro.subcategoria_armamento }}')"
          >
            Descautela C/A
          </button>
          {% else %}
          <!-- Se não houver categoria de armamento, renderiza o botão para descautela de munição -->
          <button
            class="btn btn-primary btn-sm"
            onclick="openDescautelarMunicaoModal({{ registro.id }}, '{{ registro.categoria_municao }}', '{{ registro.subcategoria_municao }}', '{{ registro.quantidade_municao }}')"
          >
            Descautela C/A
          </button>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="10" class="text-center">Nenhum registro encontrado</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  {% comment %}
  ***************************************************************************************************
  ***************************************************** MODAL
  *****************************************************
  ***************************************************************************************************
  {% endcomment %}
  <!-- Modal Descautela S/A -->
  <div
    class="modal fade"
    id="descautelarSAModal"
    tabindex="-1"
    aria-labelledby="descautelarSAModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="descautelarSAModalLabel">
            Descautela S/A
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>
            Você tem certeza que deseja realizar a descautela S/A para o
            policial
            <span id="policialNomeModal"></span>?
          </p>
          <form
            method="POST"
            action="{% url 'descautelar_sa' %}"
            id="formDescautelarSA"
          >
            {% csrf_token %}
            <input
              type="hidden"
              name="registro_id"
              id="registroIdInput"
              value=""
            />
            <button type="submit" class="btn btn-danger">
              Confirmar Descautela
            </button>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Descautela Armamento (C/A) -->
  <div
    class="modal fade"
    id="descautelarCAModal"
    tabindex="-1"
    aria-labelledby="descautelarCAModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="descautelarCAModalLabel">
            Descautela C/A - Armamento
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>
            Descautela de Armamento para
            <span id="categoriaArmamentoModal"></span> -
            <span id="subcategoriaArmamentoModal"></span>
          </p>

          <form
            method="POST"
            action="{% url 'descautelar_ca' %}"
            id="formDescautelarCA"
          >
            {% csrf_token %}
            <input
              type="hidden"
              name="registro_id"
              id="registroIdInputCA"
              value=""
            />

            <!-- Campo para Situação -->
            <div class="mb-3">
              <label for="situacaoSelect" class="form-label"
                >Situação do Armamento</label
              >
              <select class="form-select" id="situacaoSelect" name="situacao">
                <option value="disponivel">Disponível</option>
                <option value="cautelada">Cautelada</option>
                <option value="extraviado">Extraviado</option>
                <option value="roubado">Roubado</option>
                <option value="quebrado">Quebrado</option>
                <option value="furado">Furado</option>
                <option value="disparado">Disparado</option>
              </select>
            </div>

            <!-- Novo campo de Observações -->
            <div class="mb-3">
              <label for="observacaoInput" class="form-label"
                >Observações</label
              >
              <textarea
                class="form-control"
                id="observacaoInput"
                name="observacao"
                rows="3"
                placeholder="Adicione observações, se necessário"
              ></textarea>
            </div>

            <button type="submit" class="btn btn-primary">
              Confirmar Descautela
            </button>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Descautela Munição (C/A) -->
  <div
    class="modal fade"
    id="descautelarMunicaoModal"
    tabindex="-1"
    aria-labelledby="descautelarMunicaoModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="descautelarMunicaoModalLabel">
            Descautela C/A - Munição
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <p>
            Descautela de Munição da categoria
            <span id="categoriaMunicaoModal"></span> -
            <span id="subcategoriaMunicaoModal"></span>
          </p>

          <form
            method="POST"
            action="{% url 'descautelar_municao_ca' %}"
            <!--
            Certifique-se
            de
            que
            a
            URL
            está
            correta
            -- >
            id="formDescautelarMunicaoCA" > {% csrf_token %}
            <input
              type="hidden"
              name="registro_id"
              id="registroIdInputMunicao"
              value=""
            />

            <!-- Novo campo de Observações -->
            <div class="mb-3">
              <label for="observacaoInput" class="form-label"
                >Observações</label
              >
              <textarea
                class="form-control"
                id="observacaoInput"
                name="observacao"
                rows="3"
                placeholder="Adicione observações, se necessário"
              ></textarea>
            </div>

            <button type="submit" class="btn btn-primary">
              Confirmar Descautela
            </button>
          </form>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}


  {% comment %}
  *****************************************************************************************************
  ***************************************************** SCRIPTS
  *****************************************************
  ***************************************************************************************************
  {% endcomment %}

  <script>
        {% comment %} ################################################################################### {% endcomment %}

        // Função para submissão do formulário de descautela S/A via AJAX

        function openDescautelarSAModal(registroId, policialNome) {
            // Define o ID do registro e o nome do policial no modal
            document.getElementById("registroIdInput").value = registroId;
            document.getElementById("policialNomeModal").innerText = policialNome;

            // Exibe o modal de descautela S/A
            var myModal = new bootstrap.Modal(document.getElementById("descautelarSAModal"));
            myModal.show();
        }
        document.getElementById('formDescautelarSA').addEventListener('submit', function(e) {
            e.preventDefault(); // Previne o comportamento padrão de envio do formulário

            var form = this;
            var registroId = document.getElementById("registroIdInput").value;

            // Envia a requisição via AJAX
            fetch(form.action, {
              method: 'POST',
              body: new FormData(form),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Fecha o modal após o sucesso
                    var myModalSA = bootstrap.Modal.getInstance(document.getElementById("descautelarSAModal"));
                    myModalSA.hide();

                    // Remove a linha correspondente da tabela
                    var row = document.querySelector(`tr[data-registro-id="${registroId}"]`);
                    if (row) {
                        row.remove();
                    }
                } else {
                    alert('Erro ao processar a descautela: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Ocorreu um erro ao processar a descautela.');
            });
        });

        {% comment %} ################################################################################### {% endcomment %}

        // Função para abrir o modal de Descautela C/A - Armamento
        function openDescautelarArmamentoModal(registroId, categoriaArmamento, subcategoriaArmamento) {
            document.getElementById("registroIdInputCA").value = registroId;
            document.getElementById("categoriaArmamentoModal").innerText = categoriaArmamento;
            document.getElementById("subcategoriaArmamentoModal").innerText = subcategoriaArmamento;

            // Exibe o modal
            var myModalCA = new bootstrap.Modal(document.getElementById("descautelarCAModal"));
            myModalCA.show();
        }

        // Função para obter o token CSRF para o envio via AJAX
        function getCSRFToken() {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, 'csrftoken'.length + 1) === ('csrftoken=')) {
                        cookieValue = decodeURIComponent(cookie.substring('csrftoken'.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Função para submissão do formulário de descautela
        document.getElementById('formDescautelarCA').addEventListener('submit', function (e) {
            e.preventDefault(); // Previne o comportamento padrão do formulário

            var form = this;
            var registroId = document.getElementById("registroIdInputCA").value;

            // Envia a requisição via AJAX
            fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: {
                    'X-CSRFToken': getCSRFToken()  // Inclui o CSRF token no cabeçalho
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Fechar o modal após o sucesso
                    var myModalCA = bootstrap.Modal.getInstance(document.getElementById("descautelarCAModal"));
                    myModalCA.hide();

                    // Remove a linha correspondente da tabela (se aplicável)
                    var row = document.querySelector(`tr[data-registro-id="${registroId}"]`);
                    if (row) {
                        row.remove();
                    }
                } else {
                    alert('Erro ao processar a descautela: ' + (data.error || 'Desconhecido.'));
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Ocorreu um erro durante a solicitação.');
            });
        });



        {% comment %} ################################################################################### {% endcomment %}

    // Função para abrir o modal manualmente
    function abrirModalDescautelarMunicao() {
        var myModal = new bootstrap.Modal(document.getElementById('descautelarMunicaoModal'), {});
        myModal.show();
    }

    // Função para capturar e submeter os dados
    document.getElementById("formDescautelarMunicaoCA").addEventListener("submit", function(event) {
        event.preventDefault();  // Impede o comportamento padrão de recarregar a página

        // Captura o valor do campo de quantidade de munição
        var quantidadeMunicao = document.getElementById("quantidadeMunicaoInput").value;

        // Captura outros dados do formulário (exemplo: registro_id)
        var registroId = document.getElementById("registroIdInputMunicaoCA").value;

        // Envia os dados via AJAX (fetch) para o backend sem recarregar a página
        fetch("{% url 'descautelar_municao_ca' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                quantidade_municao: quantidadeMunicao,
                registro_id: registroId
            })
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert("Descautela realizada com sucesso!");
                  // Atualize a página ou feche o modal conforme necessário
                  location.reload();
              } else {
                  alert("Erro ao realizar descautela.");
              }
          }).catch((error) => {
            console.error("Erro:", error);
          });
    });
  </script>

</div>
{% endblock %}