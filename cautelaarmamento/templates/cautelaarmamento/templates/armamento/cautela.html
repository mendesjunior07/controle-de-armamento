{% extends 'base_html/base.html' %}

{% block title %}
Cautela de Armamento
{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<script>
    function updateSubcategorias(rowId) {
        var formRow = document.getElementById(rowId);
        var categoriaId = formRow.querySelector('.categoria-select').value;
        var subcategoriaSelect = formRow.querySelector('.subcategoria-select');

        // Limpar as subcategorias existentes
        subcategoriaSelect.innerHTML = '<option value="">Selecione uma Subcategoria</option>';

        if (categoriaId) {
            fetch(`/subcategorias/${categoriaId}/`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(subcategoria => {
                        var option = document.createElement('option');
                        option.value = subcategoria.id;
                        option.textContent = subcategoria.nome;
                        subcategoriaSelect.appendChild(option);
                    });
                });
        }
    }

    function addRow() {
        var tableBody = document.getElementById('form-table-body');
        var rowCount = tableBody.rows.length + 1;
        var row = tableBody.insertRow(rowCount - 1);

        row.id = `form-row${rowCount}`;
        row.innerHTML = `
            <tr>
                <td>
                    <select id="categoria${rowCount}" class="form-select categoria-select" name="categorias[]"
                        onchange="updateSubcategorias('form-row${rowCount}')">
                        <option value="">Selecione uma Categoria</option>
                        {% for categoria in categorias %}
                            <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
                        {% endfor %}
                    </select>
                </td>
                <td>
                    <select id="subcategoria${rowCount}" class="form-select subcategoria-select" name="subcategorias[]">
                        <option value="">Selecione uma Subcategoria</option>
                    </select>
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">-</button>
                </td>
            </tr>
        `;
    }

    function removeRow(button) {
        var row = button.closest('tr');
        row.parentNode.removeChild(row);
    }
</script>

<div class="container mt-4">
    <h1 class="mb-4 text-center">Cautela de Armamento e Equipamento</h1>

    <form method="POST" id="main-form" class="needs-validation" novalidate>
        {% csrf_token %}
        <div class="mb-3">
            <label for="policial-select" class="form-label">Nome do Policial:</label>
            <select id="policial-select" name="policial" class="form-select" required>
                <option value="">Selecione um Policial</option>
                {% for policial in policiais %}
                    <option value="{{ policial.id }}">{{ policial.nome }}</option>
                {% endfor %}
            </select>
            <div class="invalid-feedback">Por favor, selecione um policial.</div>
        </div>

        <div class="table-responsive">
            <table id="form-table" class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>Categoria</th>
                        <th>Subcategoria</th>
                        <th>Opções</th>
                    </tr>
                </thead>
                <tbody id="form-table-body">
                    <tr id="form-row1">
                        <td>
                            <select id="categoria1" class="form-select categoria-select" name="categorias[]" onchange="updateSubcategorias('form-row1')" required>
                                <option value="">Selecione uma Categoria</option>
                                {% for categoria in categorias %}
                                    <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <select id="subcategoria1" class="form-select subcategoria-select" name="subcategorias[]" required>
                                <option value="">Selecione uma Subcategoria</option>
                            </select>
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">-</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between mt-3">
            <button type="button" class="btn btn-success" onclick="addRow()">Adicionar Linha +</button>
            <button type="submit" class="btn btn-primary">Enviar</button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
